<a id="download" href="#" download="export.rbxmx" style="display:none;">Download</a>
<button id="convselect">Convert Selection</button>
<div></div>

<label for="apikey">Cloud API Key (optional)</label>
<input type="text" id="apikey" placeholder="Cloud API Key" />
<div></div>

<label for="userid">User ID</label>
<input type="text" id="userid" placeholder="User ID" />
<div></div>

<label for="userid">Custom Proxy</label>
<input type="text" id="prox" placeholder="Proxy URL" />
<div></div>

<label for="uploadImages">Upload Images</label>
<input type="checkbox" id="uploadImages" name="Upload Images" />
<div></div>

<label for="exportImages">Export Images</label>
<input type="checkbox" id="exportImages" name="Export Images" />

<!-- get things :) -->
<script src="https://unpkg.com/axios@1.4.0/dist/axios.min.js" integrity="sha384-I4Qw/vWb/sK/7VwepTtkaq636YLYClbEgEwKp3ueUCvjiLFrcoKUFAY5mOl40Fj3" crossorigin="anonymous"></script>
<script src="https://unpkg.com/jszip@3.7.1/dist/jszip.js" integrity="sha384-Lqk2um7o0W+Ke7IGh8Mk9EE7g2IrhepxXvttF/iw5hFqpMjFGKP4jcKYhNLAi/ZD" crossorigin="anonymous"></script>
<script type="module" src="./main.js"></script>
<script>
    var CloudApiKey = ""
    var UserId = ""
    var Proxy = ""
    var ExportImages = false
    var UploadImages = true

    function PostMessage(Data) {
        parent.postMessage({ pluginMessage: Data }, "*");
    }

    function Sleep(ms) {
        return new Promise(res => setTimeout(res, ms));
    }

    document.getElementById("convselect").onclick = () => {
        PostMessage({ type: 'run' });
    }

    const DownloadLink = document.getElementById("download");
    var Images = [];

    function DownloadImages() {
        if (!ExportImages || Images.length == 0) {
            return;
        }

        let Zip = new JSZip();

        for (let i = 0; i < Images.length; i++) {
            var Image = Images[i];
            Zip.file(`image-${Image.ImageName}(${i}).png`, new Blob([Image.ImageData.buffer], { type: "image/png" }));
        }

        Zip.generateAsync({ type: "blob" }).then((Content) => {
            DownloadLink.href = URL.createObjectURL(Content);
            DownloadLink.download = "images.zip";
            DownloadLink.click();
        });

        Images = [];
    }

    onmessage = async (event) => {
        const { type, data } = event.data.pluginMessage;
        
        switch (type) {
            case "Download":
                DownloadLink.href = "data:text/xml;charset=utf-8," + encodeURIComponent(data);
                DownloadLink.download = "export.rbxmx";
                DownloadLink.click();

                DownloadImages();
                break;
            case "UploadImage":
                const Form = new FormData();
                const blob = new Blob([data.Data.buffer], { type: "image/" + data.Format });

                if (ExportImages) {
                    Images.push(data);
                }

                if (CloudApiKey == "" || UserId == "" || !UploadImages) {
                    console.warn("Cloud API Key is not set");
                    PostMessage({ type: 'image-upload-fail', data: "Cloud API Key is not set" })
                    return;
                }

                Form.append("request", JSON.stringify({
                    assetType: "Image",
                    displayName: data.Name,
                    description: "Exported from Figma",
                    creationContext: {
                        creator: {
                            userId: parseFloat(UserId)
                        }
                    }
                }));
                Form.append("fileContent", blob, data.Name + "." + data.Format);

                fetch("https://apis.roblox.com/assets/v1/assets", {
                    method: "POST",
                    //mode: "no-cors",
                    headers: {
                        ["x-api-key"]: CloudApiKey,
                    },
                    body: Form
                }).then(res => res.json())
                    .then(async InitialResponse => {
                        if (InitialResponse.done) {
                            PostMessage({ type: "ImageUploaded", id: data.Id, data: UploadResponse.response || UploadResponse.status });
                            return;
                        }

                        PostMessage({ type: "UpdateOperationId", id: data.id, data: InitialResponse.operationId })

                        Sleep(500);

                        for (var i = 0; i < 20; i++) {
                            const UploadResponse = await (await fetch(`https://apis.roblox.com/assets/v1/${InitialResponse.path}`, {
                                method: "GET",
                                //mode: "no-cors",
                                headers: {
                                    ["x-api-key"]: CloudApiKey
                                }
                            })).json();

                            console.log("got Status Response:", UploadResponse);

                            if (UploadResponse.done) {
                                PostMessage({ type: "ImageUploaded", id: data.Id, data: UploadResponse.response || UploadResponse.status })
                                break;
                            }

                            Sleep(1500);
                        }
                    })

                break;
            case "GetAsync":
                switch (data.key) {
                    case "CloudApiKey":
                        document.getElementById("apikey").value = data.value
                        CloudApiKey = data.value
                        break;
                    case "UserId":
                        document.getElementById("userid").value = data.value
                        UserId = data.value
                        break;
                    case "ExportImages":
                        document.getElementById("exportImages").checked = data.value
                        ExportImages = data.value
                        break;
                    case "UploadImages":
                        document.getElementById("uploadImages").checked = data.value
                        UploadImages = data.value
                        break;
                    case "Proxy":
                        document.getElementById("prox").value = data.value
                        Proxy = data.value
                        break;
                }
                break;
        }
    }
</script>